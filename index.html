<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Scrapbox æ—¥å ±ãƒ­ã‚°</title>
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 600px; margin: auto; }
    section { margin-bottom: 1.5em; }
    details summary { font-weight: bold; margin-top: 1em; cursor: pointer; }
    .entry, .activity-entry, .substance-entry { display: flex; gap: 0.5em; margin-bottom: 0.5em; }
    #status-message { color: green; font-size: 0.9em; margin-top: 0.3em; }
  </style>
</head>
<body>

  <!-- æ—¥ä»˜è¡¨ç¤º -->
  <section>
    <div id="today-date"></div>
  </section>

  <!-- ç¡çœ  -->
  <section>
    <h2>ç¡çœ </h2>
    <label>å°±å¯ <input type="time" id="sleep-start" step="900"></label>
    <label>èµ·åºŠ <input type="time" id="sleep-end" step="900"></label>
    <div id="sleep-duration">ç¡çœ æ™‚é–“ï¼š</div>
  </section>

  <!-- è¡Œå‹•ãƒ¡ãƒ¢ -->
  <section>
    <h2>è¡Œå‹•ãƒ¡ãƒ¢</h2>
    <div id="activity-log"></div>
    <button id="add-activity">ï¼‹ è¡Œå‹•ã‚’è¿½åŠ </button>
  </section>

  <!-- å—œå¥½å“ -->
  <section>
    <details open>
      <summary>å—œå¥½å“</summary>
      <div id="substance-log"></div>
      <button id="add-substance">ï¼‹ å—œå¥½å“ã‚’è¿½åŠ </button>
    </details>
  </section>

  <!-- ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯ -->
  <section>
    <h2>ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯</h2>
    <label><input type="checkbox" class="symptom" value="headache"> é ­ç—›</label>
    <label><input type="checkbox" class="symptom" value="fatigue"> ç–²åŠ´æ„Ÿ</label>
    <label><input type="checkbox" class="symptom" value="anxiety"> ä¸å®‰</label>
  </section>

  <!-- è‡ªç”±è¨˜è¿°ï¼šä½“èª¿è£œè¶³ -->
  <section>
    <details>
      <summary>ä½“èª¿ã®è£œè¶³</summary>
      <textarea id="note-health" rows="3" style="width: 100%;"></textarea>
    </details>
  </section>

  <!-- è‡ªç”±è¨˜è¿°ï¼šç·è©• -->
  <section>
    <details>
      <summary>ä»Šæ—¥ã®ç·è©•</summary>
      <textarea id="note-overall" rows="3" style="width: 100%;"></textarea>
    </details>
  </section>

  <!-- è‡ªç”±è¨˜è¿°ï¼šãµã‚Šã‹ãˆã‚Š -->
  <section>
    <details>
      <summary>ãµã‚Šã‹ãˆã‚Šãƒ»æ‰€æ„Ÿ</summary>
      <textarea id="note-review" rows="3" style="width: 100%;"></textarea>
    </details>
  </section>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼‹ãƒªã‚»ãƒƒãƒˆ -->
  <section>
    <div id="status-message"></div>
    <button id="reset-storage">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </section>

  <script>
    // æ—¥ä»˜è¡¨ç¤º
    function displayToday() {
      const now = new Date();
      const days = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
      const str = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}ï¼ˆ${days[now.getDay()]}ï¼‰`;
      document.getElementById("today-date").textContent = "ğŸ“… " + str;
    }

    // ç¡çœ æ™‚é–“è¨ˆç®—
    function calculateSleepDuration() {
      const start = document.getElementById("sleep-start").value;
      const end = document.getElementById("sleep-end").value;
      const display = document.getElementById("sleep-duration");
      if (!start || !end) return display.textContent = "ç¡çœ æ™‚é–“ï¼š";
      const [sH, sM] = start.split(":").map(Number);
      const [eH, eM] = end.split(":").map(Number);
      let mins = (eH * 60 + eM) - (sH * 60 + sM);
      if (mins <= 0) mins += 1440;
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      display.textContent = `ç¡çœ æ™‚é–“ï¼š${h}æ™‚é–“${m > 0 ? m + "åˆ†" : ""}`;
    }

    // è¡Œå‹•ãƒ»å—œå¥½å“ã®å…±é€šè¿½åŠ å‡¦ç†
    function addEntry(containerId, className, content = "", time = "", saveFunc) {
      const container = document.getElementById(containerId);
      const div = document.createElement("div");
      div.className = className;
      const text = document.createElement("input");
      text.type = "text"; text.placeholder = "å†…å®¹"; text.value = content;
      const clock = document.createElement("input");
      clock.type = "time"; clock.value = time;
      text.addEventListener("input", saveFunc);
      clock.addEventListener("change", saveFunc);
      div.appendChild(text); div.appendChild(clock); container.appendChild(div);
    }

    function saveActivityLog() {
      const entries = Array.from(document.querySelectorAll(".activity-entry")).map(e => {
        const [text, time] = e.querySelectorAll("input");
        return { content: text.value, time: time.value };
      }).filter(e => e.content.trim() !== "");
      localStorage.setItem("log_activity", JSON.stringify(entries));
      showSaved();
    }

    function restoreActivityLog() {
      const data = JSON.parse(localStorage.getItem("log_activity") || "[]");
      if (data.length === 0) addEntry("activity-log", "activity-entry", "", "", saveActivityLog);
      data.forEach(e => addEntry("activity-log", "activity-entry", e.content, e.time, saveActivityLog));
    }

    function saveSubstanceLog() {
      const entries = Array.from(document.querySelectorAll(".substance-entry")).map(e => {
        const [text, time] = e.querySelectorAll("input");
        return { content: text.value, time: time.value };
      }).filter(e => e.content.trim() !== "");
      localStorage.setItem("log_substance", JSON.stringify(entries));
      showSaved();
    }

    function restoreSubstanceLog() {
      const data = JSON.parse(localStorage.getItem("log_substance") || "[]");
      if (data.length === 0) addEntry("substance-log", "substance-entry", "", "", saveSubstanceLog);
      data.forEach(e => addEntry("substance-log", "substance-entry", e.content, e.time, saveSubstanceLog));
    }

    // ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯
    function saveSymptoms() {
      const selected = Array.from(document.querySelectorAll(".symptom:checked")).map(cb => cb.value);
      localStorage.setItem("log_symptoms", JSON.stringify(selected));
      showSaved();
    }

    function restoreSymptoms() {
      const data = JSON.parse(localStorage.getItem("log_symptoms") || "[]");
      document.querySelectorAll(".symptom").forEach(cb => cb.checked = data.includes(cb.value));
    }

    // è‡ªç”±è¨˜è¿°
    function bindTextarea(id, key) {
      const el = document.getElementById(id);
      el.value = localStorage.getItem(key) || "";
      el.addEventListener("input", () => {
        localStorage.setItem(key, el.value);
        showSaved();
      });
    }

    // ç¡çœ ä¿å­˜
    function saveSleepTimes() {
      const start = document.getElementById("sleep-start").value;
      const end = document.getElementById("sleep-end").value;
      localStorage.setItem("log_sleep_start", start);
      localStorage.setItem("log_sleep_end", end);
      showSaved();
    }

    function restoreSleepTimes() {
      document.getElementById("sleep-start").value = localStorage.getItem("log_sleep_start") || "";
      document.getElementById("sleep-end").value = localStorage.getItem("log_sleep_end") || "";
      calculateSleepDuration();
    }

    // ä¿å­˜é€šçŸ¥
    let saveTimer;
    function showSaved() {
      const msg = document.getElementById("status-message");
      msg.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => msg.textContent = "", 1500);
    }

    // å…¨ãƒªã‚»ãƒƒãƒˆ
    function resetAll() {
      if (confirm("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
        ["log_sleep_start", "log_sleep_end", "log_activity", "log_substance", "log_symptoms", "log_notes", "log_overall", "log_review", "log_health"].forEach(k => localStorage.removeItem(k));
        location.reload();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    document.addEventListener("DOMContentLoaded", () => {
      displayToday();
      restoreSleepTimes();
      document.getElementById("sleep-start").addEventListener("change", () => {
        saveSleepTimes(); calculateSleepDuration();
      });
      document.getElementById("sleep-end").addEventListener("change", () => {
        saveSleepTimes(); calculateSleepDuration();
      });

      restoreActivityLog();
      restoreSubstanceLog();
      document.getElementById("add-activity").addEventListener("click", () => addEntry("activity-log", "activity-entry", "", "", saveActivityLog));
      document.getElementById("add-substance").addEventListener("click", () => addEntry("substance-log", "substance-entry", "", "", saveSubstanceLog));

      restoreSymptoms();
      document.querySelectorAll(".symptom").forEach(cb => cb.addEventListener("change", saveSymptoms));

      bindTextarea("note-health", "log_health");
      bindTextarea("note-overall", "log_overall");
      bindTextarea("note-review", "log_review");

      document.getElementById("reset-storage").addEventListener("click", resetAll);
    });
  </script>

</body>
</html>
