<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CBTãƒ­ã‚°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="style.css">
</head>
<body>

<section>
  <div id="today-date"></div>
</section>

<section>
  <h2>ç¡çœ </h2>
  <label>å°±å¯ <input type="time" id="sleep-start" step="900"></label>
  <label>èµ·åºŠ <input type="time" id="sleep-end" step="900"></label>
  <div id="sleep-duration">ç¡çœ æ™‚é–“ï¼š</div>
</section>

<section>
  <h2>è¡Œå‹•ãƒ¡ãƒ¢</h2>
  <div id="activity-log"></div>
  <button id="add-activity">ï¼‹ è¡Œå‹•ã‚’è¿½åŠ </button>
</section>

<section>
  <details open>
    <summary>å—œå¥½å“</summary>
    <div id="substance-log"></div>
    <button id="add-substance">ï¼‹ å—œå¥½å“ã‚’è¿½åŠ </button>
  </details>
</section>

<section>
  <h2>ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯</h2>

  <h3>èº«ä½“</h3>
  <label><input type="checkbox" class="symptom" value="é ­ç—›"> é ­ç—›</label>
  <label><input type="checkbox" class="symptom" value="å€¦æ€ æ„Ÿ"> å€¦æ€ æ„Ÿ</label>
  <label><input type="checkbox" class="symptom" value="èƒƒã‚‚ãŸã‚Œ"> èƒƒã‚‚ãŸã‚Œ</label>
  <label><input type="checkbox" class="symptom" value="è‚©ã“ã‚Š"> è‚©ã“ã‚Š</label>
  <label><input type="checkbox" class="symptom" value="å†·ãˆ"> å†·ãˆ</label>
  <label><input type="checkbox" class="symptom" value="ã»ã¦ã‚Š"> ã»ã¦ã‚Š</label>

  <h3>ãƒ¡ãƒ³ã‚¿ãƒ«</h3>
  <label><input type="checkbox" class="symptom" value="ä¸å®‰"> ä¸å®‰</label>
  <label><input type="checkbox" class="symptom" value="æŠ‘ã†ã¤"> æŠ‘ã†ã¤</label>
  <label><input type="checkbox" class="symptom" value="ç„¦ç‡¥æ„Ÿ"> ç„¦ç‡¥æ„Ÿ</label>
  <label><input type="checkbox" class="symptom" value="æ°—åŠ›ä½ä¸‹"> æ°—åŠ›ä½ä¸‹</label>
  <label><input type="checkbox" class="symptom" value="éé›†ä¸­"> éé›†ä¸­</label>
  <label><input type="checkbox" class="symptom" value="å¯¾äººã‚¹ãƒˆãƒ¬ã‚¹"> å¯¾äººã‚¹ãƒˆãƒ¬ã‚¹</label>

  <h3>ãã®ä»–</h3>
  <label><input type="checkbox" class="symptom" value="ã‚ã¾ã„"> ã‚ã¾ã„</label>
  <label><input type="checkbox" class="symptom" value="éé£Ÿ"> éé£Ÿ</label>
  <label><input type="checkbox" class="symptom" value="å¤œé–“è¦šé†’"> å¤œé–“è¦šé†’</label>
  <label><input type="checkbox" class="symptom" value="å‹•æ‚¸"> å‹•æ‚¸</label>
</section>

<section>
  <details>
    <summary>ä½“èª¿ã®è£œè¶³</summary>
    <textarea id="note-health" rows="3" style="width: 100%;"></textarea>
  </details>
</section>

<section>
  <details>
    <summary>ä»Šæ—¥ã®ç·è©•</summary>
    <textarea id="note-overall" rows="3" style="width: 100%;"></textarea>
  </details>
</section>

<section>
  <details>
    <summary>ãµã‚Šã‹ãˆã‚Šãƒ»æ‰€æ„Ÿ</summary>
    <textarea id="note-review" rows="3" style="width: 100%;"></textarea>
  </details>
</section>

<section>
  <div id="status-message"></div>
  <button id="generate-output">Scrapboxç”¨ã«å‡ºåŠ›</button>
  <button id="post-gist">Gistã«æŠ•ç¨¿ã—ã¦å…±æœ‰</button>
  <div>
    <label>ãƒ•ã‚¡ã‚¤ãƒ«åï¼š<input type="text" id="filename" placeholder="yyyy-mm-dd.md"></label>
    <label>GitHub Tokenï¼š<input type="password" id="token" placeholder="ghp_..."></label>
  </div>

  
  <pre id="output-text" style="white-space: pre-wrap; background: #f0f0f0; padding: 1em; margin-top: 1em;"></pre>
  <button id="reset-storage">ä¸€æ™‚ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</section>

<section>
  <div id="readme">
    <a href="./README">ä½¿ã„æ–¹</a>
  </div>
</section>

<script>
  const days = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
  function displayToday() {
    const now = new Date();
    const str = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}ï¼ˆ${days[now.getDay()]}ï¼‰`;
    document.getElementById("today-date").textContent = "ğŸ“… " + str;
  }

  function calculateSleepDuration() {
    const start = document.getElementById("sleep-start").value;
    const end = document.getElementById("sleep-end").value;
    const display = document.getElementById("sleep-duration");
    if (!start || !end) return display.textContent = "ç¡çœ æ™‚é–“ï¼š";
    const [sH, sM] = start.split(":").map(Number);
    const [eH, eM] = end.split(":").map(Number);
    let mins = (eH * 60 + eM) - (sH * 60 + sM);
    if (mins <= 0) mins += 1440;
    const h = Math.floor(mins / 60), m = mins % 60;
    display.textContent = `ç¡çœ æ™‚é–“ï¼š${h}æ™‚é–“${m > 0 ? m + "åˆ†" : ""}`;
  }

  function showSaved() {
    const msg = document.getElementById("status-message");
    msg.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
    clearTimeout(window._saveTimer);
    window._saveTimer = setTimeout(() => msg.textContent = "", 1500);
  }

  function addEntry(containerId, className, content = "", time = "", saveFunc) {
    const c = document.getElementById(containerId);
    const div = document.createElement("div");
    div.className = className;
    const text = document.createElement("input");
    text.type = "text"; text.placeholder = "å†…å®¹"; text.value = content;
    div.appendChild(text);
    if (className !== "substance-entry") {
      const clock = document.createElement("input");
      clock.type = "time"; clock.value = time;
      clock.addEventListener("change", saveFunc);
      div.appendChild(clock);
    }
    text.addEventListener("input", saveFunc);
    c.appendChild(div);
  }

  function saveEntries(className, storageKey) {
    const entries = Array.from(document.querySelectorAll("." + className)).map(e => {
      const inputs = e.querySelectorAll("input");
      return {
        content: inputs[0].value,
        time: inputs[1] ? inputs[1].value : undefined
      };
    }).filter(e => e.content.trim() !== "");
    localStorage.setItem(storageKey, JSON.stringify(entries));
    showSaved();
  }

  function restoreEntries(containerId, className, storageKey) {
    const data = JSON.parse(localStorage.getItem(storageKey) || "[]");
    if (data.length === 0) addEntry(containerId, className, "", "", () => saveEntries(className, storageKey));
    data.forEach(e => addEntry(containerId, className, e.content, e.time, () => saveEntries(className, storageKey)));
  }

  function bindTextarea(id, key) {
    const el = document.getElementById(id);
    el.value = localStorage.getItem(key) || "";
    el.addEventListener("input", () => {
      localStorage.setItem(key, el.value);
      showSaved();
    });
  }

  function saveSymptoms() {
    const selected = Array.from(document.querySelectorAll(".symptom:checked")).map(cb => cb.value);
    localStorage.setItem("log_symptoms", JSON.stringify(selected));
    showSaved();
  }

  function restoreSymptoms() {
    const data = JSON.parse(localStorage.getItem("log_symptoms") || "[]");
    document.querySelectorAll(".symptom").forEach(cb => cb.checked = data.includes(cb.value));
  }

  function saveSleepTimes() {
    localStorage.setItem("log_sleep_start", document.getElementById("sleep-start").value);
    localStorage.setItem("log_sleep_end", document.getElementById("sleep-end").value);
    showSaved();
  }

  function restoreSleepTimes() {
    document.getElementById("sleep-start").value = localStorage.getItem("log_sleep_start") || "";
    document.getElementById("sleep-end").value = localStorage.getItem("log_sleep_end") || "";
    calculateSleepDuration();
  }

  function resetAll() {
    if (confirm("ä¸€æ™‚ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
      ["log_sleep_start","log_sleep_end","log_activity","log_substance","log_symptoms","log_health","log_overall","log_review"].forEach(k => localStorage.removeItem(k));
      location.reload();
    }
  }

  function generateScrapboxOutput() {
    const output = [];
    const now = new Date();
    const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}ï¼ˆ${days[now.getDay()]}ï¼‰`;
    output.push(`[${dateStr}]`, "");

    // ç¡çœ 
    const s = localStorage.getItem("log_sleep_start"), e = localStorage.getItem("log_sleep_end");
    if (s || e) {
      output.push("â–  ç¡çœ ");
      if (s) output.push(`- å°±å¯ï¼š${s}`);
      if (e) output.push(`- èµ·åºŠï¼š${e}`);
      if (s && e) {
        const [sH, sM] = s.split(":").map(Number);
        const [eH, eM] = e.split(":").map(Number);
        let mins = (eH*60+eM)-(sH*60+sM); if (mins <= 0) mins += 1440;
        output.push(`- ç¡çœ æ™‚é–“ï¼š${Math.floor(mins/60)}æ™‚é–“${mins%60 > 0 ? mins%60 + "åˆ†" : ""}`);
      }
      output.push("");
    }

    // è¡Œå‹•ãƒ¡ãƒ¢
    const act = JSON.parse(localStorage.getItem("log_activity") || "[]");
    if (act.length) {
      output.push("â–  è¡Œå‹•ãƒ¡ãƒ¢");
      act.forEach(e => output.push(`- ${e.time ? e.time + " " : ""}${e.content}`));
      output.push("");
    }

    // å—œå¥½å“
    const sub = JSON.parse(localStorage.getItem("log_substance") || "[]");
    if (sub.length) {
      output.push("â–  å—œå¥½å“");
      sub.forEach(e => output.push(`- ${e.content}`));
      output.push("");
    }

    const sym = JSON.parse(localStorage.getItem("log_symptoms") || "[]");
    if (sym.length) {
      output.push("â–  ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯");
      sym.forEach(s => output.push(`- ${s}`));
      output.push("");
    }

    [["log_health", "ä½“èª¿ã®è£œè¶³"], ["log_overall", "ä»Šæ—¥ã®ç·è©•"], ["log_review", "ãµã‚Šã‹ãˆã‚Šãƒ»æ‰€æ„Ÿ"]]
      .forEach(([key, title]) => {
        const val = localStorage.getItem(key);
        if (val?.trim()) output.push(`â–  ${title}`, val.trim(), "");
      });

    // å„è¡Œã®æœ«å°¾ã«ã‚¹ãƒšãƒ¼ã‚¹ï¼’ã¤ã‚’ã¤ã‘ã¦æ”¹è¡Œ
    const md = output.map(line => line + "  ").join("\n");
    document.getElementById("output-text").textContent = md;
  }

  document.addEventListener("DOMContentLoaded", () => {
    displayToday();
    restoreSleepTimes();
    restoreEntries("activity-log", "activity-entry", "log_activity");
    restoreEntries("substance-log", "substance-entry", "log_substance");
    restoreSymptoms();
    bindTextarea("note-health", "log_health");
    bindTextarea("note-overall", "log_overall");
    bindTextarea("note-review", "log_review");

    document.getElementById("sleep-start").addEventListener("change", () => { saveSleepTimes(); calculateSleepDuration(); });
    document.getElementById("sleep-end").addEventListener("change", () => { saveSleepTimes(); calculateSleepDuration(); });
    document.getElementById("add-activity").addEventListener("click", () => addEntry("activity-log", "activity-entry", "", "", () => saveEntries("activity-entry", "log_activity")));
    document.getElementById("add-substance").addEventListener("click", () => addEntry("substance-log", "substance-entry", "", "", () => saveEntries("substance-entry", "log_substance")));
    document.querySelectorAll(".symptom").forEach(cb => cb.addEventListener("change", saveSymptoms));
    document.getElementById("reset-storage").addEventListener("click", resetAll);
    document.getElementById("generate-output").addEventListener("click", generateScrapboxOutput);
  });

  // ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ yyyy-mm-dd.md ã§åŸ‹ã‚ã‚‹
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('filename');
    if (!input) return;
    // ãƒ­ãƒ¼ã‚«ãƒ«ã®æ—¥ä»˜ã‚’å–å¾—
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm   = String(now.getMonth() + 1).padStart(2, '0');
    const dd   = String(now.getDate()).padStart(2, '0');
    const dateStr = `${yyyy}-${mm}-${dd}`;
    input.value = `${dateStr}.md`;

    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ localStorage ã‹ã‚‰å¾©å…ƒ
    const tokenInput = document.getElementById('token');
    const savedToken = localStorage.getItem('github_token');
    if (tokenInput && savedToken) {
      tokenInput.value = savedToken;
    }

    // Tokenæ¬„ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ localStorage ã«ä¿å­˜
    if (tokenInput) {
      tokenInput.addEventListener('input', () => {
        localStorage.setItem('github_token', tokenInput.value);
      });
    }
  });
</script>

  <script type="module" src="gist-util.js"></script>
  <script type="module" src="gist.js"></script>
</body>
</html>
